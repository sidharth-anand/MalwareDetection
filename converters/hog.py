import math

import skimage.feature
import numpy as np

from core.config import DatasetConfig
from core.utils import DatasetUtils

from datasets.msbig import MSBig

class HOG(MSBig):
    OUTPUT_CHANNELS = 1

    def __init__(self, path: str, config: DatasetConfig, utils: DatasetUtils) -> None:
        super().__init__(path, MSBig.Type.BYTES, config, utils)

    def _convert_to_image(self, file: str) -> np.array:
        file_data = super()._get_byte_data(file)

        width = 47 * 15
        height = math.ceil(len(file_data) / width)

        image = np.array(file_data + [0] * (height * width - len(file_data)), dtype=np.uint8).reshape((height, width))
        _, hog_image = skimage.feature.hog(image, orientations = 8, pixels_per_cell = (16, 16), cells_per_block = (1, 1), visualize=True)

        return hog_image.reshape(height, width, 1)
