import os
import abc
import json
import typing

from core.dataset import Dataset
from core.config import DatasetConfig
from core.utils import DatasetUtils

class MOTIF(Dataset, metaclass=abc.ABCMeta):
    def __init__(self, path: str, config: DatasetConfig, utils: DatasetUtils) -> None:
        self.classes = {}
        self.class_indices = {}

        super().__init__(path, config, utils)

    def _get_dataset(self) -> Dataset.DatasetType:
        data_path = os.path.join(self.path, 'motif_dataset.jsonl')

        dataset = []

        with open(data_path, 'r') as f:
            for line in f.readlines():
                data = json.loads(line)

                if not data['label'] in self.class_indices:
                    self.class_indices[data['label']] = len(self.classes)
                    self.classes[len(self.classes)] = data['label']

                dataset.append((os.path.join(self.path, f'MOTIF_{data["md5"]}'), self.class_indices[data['label']]))

        return dataset

    def _get_classes(self) -> typing.Dict[int, str]:
        return self.classes
